{ config, lib, pkgs, ... }:
let
  imap = "127.0.0.1:143";
  submission = "127.0.0.1:587";
in
{
  sops.secrets = {
    dkim.reloadUnits = [ "maddy.service" ];
  };
  systemd.packages = [ pkgs.maddy ];
  environment.systemPackages = [ pkgs.maddy ];
  users.users.maddy.isSystemUser = true;
  users.users.maddy.group = "maddy";
  users.groups.maddy = { };
  environment.etc."maddy/maddy.conf".text = ''
    $(local_domains) = nichi.co nichi.link

    hostname ${config.networking.fqdn}
    autogenerated_msg_domain nichi.co
    tls off

    auth.pass_table local_authdb {
        table sql_table {
            driver sqlite3
            dsn credentials.db
            table_name passwords
        }
    }

    storage.imapsql local_mailboxes {
        driver sqlite3
        dsn imapsql.db
    }

    smtp tcp://[::]:25 {
        tls self_signed
        source $(local_domains) {
            reject 501 5.1.8 "Use Submission for outgoing SMTP"
        }
        dmarc yes
        check {
            require_mx_record
            dkim
            spf {
                softfail_action quarantine
            }
            dnsbl zen.spamhaus.org
        }
        default_source {
            destination $(local_domains) {
                modify {
                    replace_rcpt static {
                        entry noc@nichi.co nickcao@nichi.co
                    }
                }
                deliver_to &local_mailboxes
            }
            default_destination {
                reject 550 5.1.1 "User doesn't exist"
            }
        }
    }

    submission tcp://${submission} {
        auth &local_authdb
        source $(local_domains) {
            check {
                authorize_sender {
                    user_to_email identity
                }
            }
            destination $(local_domains) {
                deliver_to &local_mailboxes
            }
            default_destination {
                modify {
                    modify.dkim {
                        domains $(local_domains)
                        selector default
                        key_path {env:CREDENTIALS_DIRECTORY}/dkim.key
                    }
                }
                deliver_to &remote_queue
            }
        }
        default_source {
            reject 501 5.1.8 "Non-local sender domain"
        }
    }

    target.remote outbound_delivery {
    }

    target.queue remote_queue {
        target &outbound_delivery
        bounce {
            destination $(local_domains) {
                deliver_to &local_mailboxes
            }
            default_destination {
                reject 550 5.0.0 "Refusing to send DSNs to non-local addresses"
            }
        }
    }

    imap tcp://${imap} {
        auth &local_authdb
        storage &local_mailboxes
    }
  '';
  systemd.services.maddy = {
    wantedBy = [ "multi-user.target" ];
    reloadTriggers = [ config.environment.etc."maddy/maddy.conf".source ];
    serviceConfig = {
      LoadCredential = [
        "dkim.key:${config.sops.secrets.dkim.path}"
      ];
    };
  };

  services.traefik = {
    staticConfigOptions = {
      entryPoints = {
        imap = {
          address = ":993";
          http.tls.certResolver = "le";
        };
        submission = {
          address = ":465";
          http.tls.certResolver = "le";
        };
      };
    };
    dynamicConfigOptions = {
      tcp = {
        routers = {
          imap = {
            rule = "HostSNI(`${config.networking.fqdn}`)";
            entryPoints = [ "imap" ];
            service = "imap";
            tls = { };
          };
          submission = {
            rule = "HostSNI(`${config.networking.fqdn}`)";
            entryPoints = [ "submission" ];
            service = "submission";
            tls = { };
          };
        };
        services = {
          imap.loadBalancer.servers = [{ address = imap; }];
          submission.loadBalancer.servers = [{ address = submission; }];
        };
      };
    };
  };
}
