$(hostname) = hel0.nichi.link
$(primary_domain) = nichi.co
$(local_domains) = $(primary_domain) nichi.link

hostname $(hostname)
autogenerated_msg_domain $(primary_domain)
tls off

auth.pass_table local_authdb {
    table sql_table {
        driver sqlite3
        dsn credentials.db
        table_name passwords
    }
}

storage.imapsql local_mailboxes {
    driver sqlite3
    dsn imapsql.db
}

smtp tcp://[::]:25 {
    tls self_signed
    source $(local_domains) {
        reject 501 5.1.8 "Use Submission for outgoing SMTP"
    }
    default_source {
        destination $(local_domains) {
            deliver_to &local_mailboxes
        }
        default_destination {
            reject 550 5.1.1 "User doesn't exist"
        }
    }
}

submission tcp://127.0.0.1:587 {
    auth &local_authdb
    source $(local_domains) {
        check {
            authorize_sender {
                user_to_email identity
            }
        }
        destination $(local_domains) {
            deliver_to &local_mailboxes
        }
        default_destination {
            modify {
                modify.dkim {
                    domains $(local_domains)
                    selector default
                    key_path {env:CREDENTIALS_DIRECTORY}/dkim.key
                }
            }
            deliver_to &remote_queue
        }
    }
    default_source {
        reject 501 5.1.8 "Non-local sender domain"
    }
}

target.remote outbound_delivery {
}

target.queue remote_queue {
    target &outbound_delivery
    bounce {
        destination $(local_domains) {
            deliver_to &local_mailboxes
        }
        default_destination {
            reject 550 5.0.0 "Refusing to send DSNs to non-local addresses"
        }
    }
}

imap tcp://127.0.0.1:143 {
    auth &local_authdb
    storage &local_mailboxes
}